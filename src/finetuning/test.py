from transformers import AutoModel, AutoTokenizer
import torch
import torch.nn as nn


texts=[None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, ["It's the morning of a day in January. ", 'The current weather is partly sunny. ', 'The weather is expected to clear up initially, becoming cloudier as the hours pass. ', 'The temperature will see a slight drop before stabilizing. ', 'There is a Gentle Breeze from the SW. ', 'The atmospheric pressure is average. ', 'The humidity will rise slightly, making the air quite humid.'], None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, ["It's the afternoon of a day in January.", 'The current weather has broken clouds.', 'The weather is transitioning from partly sunny to passing clouds.', 'The temperature is showing a slight decrease.', 'There is a Gentle Breeze from S.', 'The atmospheric pressure is average. ', 'The humidity is very high.'], None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, ["It's the evening of a day in January. ", 'The current weather is clear. ', 'The weather details for the next few hours are not provided. ', 'Temperature trend information is not available. ', 'There is a Gentle Breeze from S.', 'The atmospheric pressure is low. ', 'The humidity is very high.'], None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, ["It's the early morning of a day in January. ", 'The current weather is clear. ', 'The weather is expected to remain clear throughout the period.', 'The temperature will hover around a steady range.', 'There is a Gentle Breeze blowing from the South.', 'The atmospheric pressure is low. ', 'The humidity levels are on the higher side.'], None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, ["It's the morning of a day in January. ", 'The current weather is characterized by broken clouds. ', 'The weather is initially clear but will transition to broken clouds. ', 'The temperature is slightly increasing. ', 'There is a Gentle Breeze from S.', 'The atmospheric pressure is low. ', 'The humidity is becoming more humid towards the end.'], None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, ["It's the afternoon of a day in January.", 'The current weather is partly sunny. ', 'The weather is expected to show a mix of broken clouds and some sun, with occasional sprinkles later.', 'The temperature is holding steady.', 'There is a Moderate Breeze from SSW.', 'The atmospheric pressure is low. ', 'The air is very humid.'], None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, ["It's the evening of a day in January. ", 'The current weather is expected to have passing clouds.', 'Due to lack of fine-grained data, precise trend information is not available.', 'With the general trend, temperatures might slightly fluctuate between cool intervals.', 'There is a Gentle Breeze coming from SW.', 'The atmospheric pressure is considered Low.', 'The humidity level is quite high.'], None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, ["It's the early morning of a day in January. ", 'The current weather is passing clouds.', 'The weather is expected to clear up towards the end.', 'The temperature is showing slight fluctuations.', 'There is a Moderate Breeze from SSW.', 'The atmospheric shows Low Pressure.', 'The humidity is very high.'], None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, ["It's the morning of a day in January. ", 'The current weather is passing clouds.', 'The weather will transition from passing clouds to clear skies and sunny periods. ', 'The temperature is slightly rising. ', 'There is a Gentle Breeze from S.', 'The atmospheric pressure is low. ', 'The air is very humid, becoming slightly less so towards noon.'], None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, ["It's the afternoon of a day in January.", 'The current weather is marked by broken clouds.', 'Expect a mix of sun and clouds, transitioning to clearer skies.', 'The temperature will hover steadily around cool degrees.', "There's a Moderate Breeze from SSW.", 'The atmospheric pressure is on the lower end of average.', 'Humidity levels are notably high.'], None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, ["It's the evening of a day in January. ", 'The current weather is expected to have passing clouds.', 'Due to lack of fine-grained data, precise trend information is not available.', "With only general information, it's expected to have a slight variation in temperature.", 'The wind comes as a Gentle Breeze from the SW.', 'The atmospheric pressure is low. ', 'The humidity level is very humid.'], None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, ["It's the early morning of a day in January. ", 'The current weather is clear. ', 'Initially clear, a brief period of rain showers and clouds will be observed before clearing up again. ', 'The temperature will overall decrease slightly, hitting a low before slightly recovering. ', 'There is a Moderate Breeze evolving to a Gentle Breeze, predominantly from the Southwest to Northeast. ', 'The atmospheric pressure varies from low to average. ', 'The humidity trends from high to slightly less humid by the end of the period.'], None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, ["It's the morning of a day in January. ", 'The current weather is sunny. ', 'The weather is expected to remain clear transitioning to sunny as the morning progresses. ', 'The temperature will slightly fluctuate but largely remain steady. ', 'There is a Gentle Breeze from the South to the North. ', 'The atmospheric pressure is average, trending towards low pressure. ', 'The humidity remains very high throughout the morning.'], None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, ["It's the afternoon of a day in January.", 'The current weather is sunny. ', 'The weather is expected to turn from sunny to clear.', 'The temperature is slightly decreasing.', 'There is a Gentle Breeze from the Southeast transitioning to East-northeast.', 'The atmospheric pressure is overall low.', 'The humidity is high, slightly decreasing towards the end.'], None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, ["It's the evening of a day in January. ", 'The current weather is light rain and partly cloudy.', 'Without detailed forecasts, expect similar weather conditions to persist into the night.', 'The temperature is expected to remain nearly constant.', 'There is Light Breeze from SSW.', 'The atmospheric shows Very Low Pressure.', 'The humidity is very high.'], None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, ["It's the early morning of a day in January. ", 'The current weather shows passing clouds. ', 'The weather is expected to shift from passing clouds to partly cloudy, clearing up towards the end. ', 'The temperature remains relatively stable, showing a slight variation. ', 'There is a Light Breeze from South to South-southwest. ', 'The atmospheric pressure is on the edge of Very Low Pressure. ', 'The humidity is very high.'], None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, ["It's the morning of a day in January. ", 'The current weather is light rain with some sunshine. ', 'Intermittent rain will move through, brightening later on. ', 'The temperature will generally hold steady. ', 'Winds shift from Gentle Breeze from SW to Gentle Breeze from W. ', 'The atmospheric pressure is showing a slight increase but remains Low Pressure. ', 'The humidity remains high throughout.'], None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, ["It's the afternoon of a day in January.", 'The current weather is partly sunny. ', 'The weather will transition from partly sunny to clear by the evening.  ', 'The temperature is slightly dropping.  ', 'There is a Gentle Breeze from the West becoming lighter towards the evening.  ', 'The atmospheric pressure is low but increasing.  ', 'The humidity is high throughout.'], None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, ["It's the evening of a day in January. ", 'The current weather is clear. ', 'The weather is expected to remain clear, as no fine details are provided. ', 'The temperature is steady, hovering around the low single digits. ', 'There is a Gentle Breeze from SSW. ', 'The atmospheric shows Average Pressure. ', 'The humidity is very high.'], None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, ["It's the early morning of a day in January. ", 'The current weather is clear. ', 'The weather will mostly stay clear with some passing clouds initially. ', 'The temperature is slightly fluctuating around a steady range. ', 'There is a Gentle Breeze from SSW. ', 'The atmospheric pressure is average. ', 'The air feels quite humid.'], None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, ["It's the morning of a day in January. ", 'The current weather is partly sunny. ', 'The weather is expected to transition from clear to partly sunny with some broken clouds. ', 'The temperature is showing a gradual increase. ', 'There is a Gentle Breeze from S to SSW. ', 'The atmospheric pressure is average. ', 'The humidity is humid.'], None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, ["It's the afternoon of a day in January.", 'The current weather is partly sunny. ', 'The weather is expected to shift from broken clouds to clear skies.', 'The temperature is relatively stable.', 'There is a Gentle Breeze from SSW, transitioning from a Moderate Breeze earlier.', 'The atmospheric pressure is average. ', 'The humidity is quite high, slightly decreasing as the skies clear.'], None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, ["It's the evening of a day in January. ", 'The current weather is clear. ', 'The weather forecast details are not provided, but the overall condition is expected to be consistent with the current clear weather. ', 'The temperature trend cannot be determined without more detailed information. ', 'There is a Gentle Breeze from S.', 'The atmospheric shows Average Pressure. ', 'The humidity is humid.'], None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, ["It's the early morning of a day in January. ", 'The current weather condition is light rain with partly cloudy skies. ', 'The weather is expected to transition from light rain to clear skies, with periods of partly cloudy conditions. ', 'The temperature is relatively steady, with a slight fluctuation. ', 'There is a Gentle Breeze from SSW. ', 'The atmospheric pressure is average. ', 'The humidity remains very high throughout the period.'], None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, ["It's the morning of a day in January. ", 'The current weather is passing clouds.', 'The weather is expected to remain mostly cloudy with scattered clouds briefly.', 'The temperature is gradually increasing.', 'There is Gentle Breeze from SW.', 'The atmospheric pressure is average. ', 'The air is quite humid.'], None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, ["It's the afternoon of a day in January.", 'The current weather is sunny. ', 'The weather will transition from passing clouds to clear skies.', 'The temperature is expected to slightly decrease.', 'There is a Gentle Breeze from SW.', 'The atmospheric pressure is average. ', 'The air feels somewhat humid.'], None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, ["It's the evening of a day in January. ", 'The current weather is clear. ', 'The weather forecast details are not provided, but the overall condition is expected to be consistent with the current clear weather. ', 'The temperature is expected to remain steady, with a slight variation. ', 'There is a Gentle Breeze from SSW. ', 'The atmospheric shows Average Pressure. ', 'The humidity is humid.'], None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, ["It's the early morning of a day in January. ", 'The current weather is passing clouds.', 'The weather will switch between passing clouds and clear skies. ', 'The temperature shows slight fluctuations. ', 'There is a Gentle Breeze from SSW. ', 'The atmospheric pressure is average. ', 'The air is very humid.'], None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, ["It's the morning of a day in January. ", 'The current weather is scattered clouds.', 'The weather will transition from light rain to scattered clouds with periods of passing clouds.', 'The temperature is gradually rising.', 'There is a Moderate Breeze from WSW.', 'The atmospheric pressure is average. ', 'The humidity decreases slightly but remains humid.'], None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, ["It's the afternoon of a day in January.", 'The current weather is partly sunny. ', 'The weather will be changing from partly sunny to clear.', 'The temperature will drop slightly.', 'There is a Moderate Breeze from WSW.', 'The atmospheric pressure is high.', 'The air is rather humid.'], None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, ["It's the evening of a day in January. ", 'The current weather is clear. ', 'The weather forecast details are not provided, but the overall condition is expected to be consistent with the current clear weather. ', 'The temperature is expected to fluctuate slightly within a mild range. ', 'There is Light Breeze from SSW.', 'The atmospheric pressure is high.', 'The air is quite humid.'], None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, ["It's the early morning of a day in January. ", 'The current weather is clear. ', 'The weather is expected to remain clear, with a small chance of light rain towards the end. ', 'The temperature is gradually increasing.', 'There is a Gentle Breeze from SSW. ', 'The atmospheric pressure is high, showing a slight decrease towards the end. ', 'The humidity is very high.'], None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, ["It's the morning of a day in January. ", 'The current weather is sunny. ', 'The weather will be sunny interspersed with brief rain and passing clouds, becoming mostly sunny later.', 'The temperature will gradually increase.', 'There is a Gentle Breeze from SSW. ', 'The atmospheric pressure is average, leaning towards low.', 'The humidity starts off very high, with a slight decrease observed later.'], None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, ["It's the afternoon of a day in January.", 'The current weather is partly sunny. ', 'The weather shows a trend of broken clouds moving towards light rain towards the end. ', 'The temperature is relatively steady with a slight dip. ', 'There is a Moderate Breeze from SW. ', 'The atmospheric pressure is low and slightly dropping. ', 'The humidity is generally high with a slight increase towards the end.'], None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, ["It's the evening of a day in January. ", 'The current weather is partly cloudy.', 'The weather details are not provided, but expect a generally cloudy sky.', 'Temperature trends are unavailable, but it is expected to be cool.', 'There is a Moderate Breeze coming from WSW.', 'The atmospheric pressure is low. ', 'The humidity is humid.'], None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, ["It's the early morning of a day in January. ", 'The current weather features passing clouds.', 'The weather is expected to remain largely unchanged with passing clouds.', 'The temperature is showing a slight decrease.', 'There is a Moderate Breeze from WSW.', 'The atmospheric pressure is average. ', 'The humidity is very high.'], None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, ["It's the morning of a day in January. ", 'The current weather features passing clouds.', 'The weather will continue to show passing clouds with brief periods of scattered clouds. ', 'The temperature will gently rise. ', 'There is a Gentle Breeze from WSW. ', 'The atmospheric pressure is average. ', 'The air feels quite moist.'], None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, ["It's the afternoon of a day in January.", 'The current weather includes sprinkles with scattered clouds. ', 'The weather trend shows an expected mix of passing clouds, moments of sunshine, and occasional sprinkles. ', 'The temperature is likely to experience a slight decrease throughout the period. ', 'There is Moderate Breeze blowing from WSW. ', 'The atmospheric pressure is high.', 'The humidity is high, gradually increasing.'], None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, ["It's the evening of a day in January. ", 'The current weather is clear. ', 'The weather forecast details are not provided, but the overall condition is expected to be consistent with the current clear weather. ', 'The temperature trend cannot be determined without detailed information. ', 'The wind is expected to be a Gentle Breeze from SW. ', 'The atmospheric pressure is high.', 'The air is very humid.'], None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, ["It's the early morning of a day in January. ", 'The current weather is clear. ', 'The weather is expected to remain clear.', 'The temperature is slightly increasing. ', 'There is a Gentle Breeze from SW.', 'The atmospheric shows High Pressure.', 'The humidity is very high.'], None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, ["It's the morning of a day in January. ", 'The current weather is sunny. ', 'The weather will keep clear and sunny.', 'The temperature is slightly fluctuating but will have a mild rise.', 'There is a Gentle Breeze from SSW to SW.', 'The atmospheric pressure is average. ', 'The air is very humid.'], None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None]

text_model_name = "bert-base-uncased"
tokenizer = AutoTokenizer.from_pretrained(text_model_name)
text_encoder = AutoModel.from_pretrained(text_model_name)

# 2. 线性变换到 TimesFM 需要的维度
text_proj = nn.Linear(text_encoder.config.hidden_size, 128)
def encode_text(text_batch):
        """将文本转换为 text_embedding,支持 batch 处理，同时保留 None 位置"""
        if not text_batch:
            return None  # 空列表直接返回 None
        
        # 处理非 None 的文本
        valid_texts = [t for t in text_batch if t is not None]
        if not valid_texts:  # 如果全是 None
            return [None] * len(text_batch)
        
        # 如果 valid_texts 是 List[List[str]]，需要 flatten
        if any(isinstance(t, list) for t in valid_texts):
            valid_texts = [item for sublist in valid_texts for item in sublist]  # Flatten
        print(valid_texts)
        # Tokenizer 编码
        tokens = tokenizer(valid_texts, return_tensors="pt", padding=True, truncation=True)
        with torch.no_grad():
            text_embeddings = text_encoder(**tokens).last_hidden_state  # (batch, text_len, hidden_size)
        projected_embeddings = text_proj(text_embeddings)  # (batch, text_len, model_dims)

        # 恢复原始 batch 结构
        full_embeddings = []
        idx = 0
        for text in text_batch:
            if text is None:
                full_embeddings.append(None)  # 保持 None
            else:
                full_embeddings.append(projected_embeddings[idx])
                idx += 1

        return full_embeddings  # 保持原来的 batch 结构

if __name__ == "__main__":
    embedding = encode_text(texts)
    print(embedding)